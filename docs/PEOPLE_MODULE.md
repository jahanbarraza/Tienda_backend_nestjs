# M√≥dulo de Gesti√≥n de Personas - StampOut POS

## Descripci√≥n General

El m√≥dulo de Gesti√≥n de Personas es un componente fundamental del sistema StampOut POS que maneja toda la informaci√≥n relacionada con personas, usuarios, roles y tipos de identificaci√≥n. Este m√≥dulo proporciona una base s√≥lida para la gesti√≥n de recursos humanos y control de acceso en el sistema.

## Arquitectura del M√≥dulo

El m√≥dulo est√° organizado en cuatro subm√≥dulos principales:

### 1. Tipos de Identificaci√≥n
- **Prop√≥sito**: Gestionar los diferentes tipos de documentos de identificaci√≥n
- **Funcionalidades**: CRUD completo con validaciones y estad√≠sticas
- **Casos de uso**: C√©dula, Pasaporte, Licencia de Conducir, etc.

### 2. Roles
- **Prop√≥sito**: Definir roles y permisos dentro del sistema
- **Funcionalidades**: CRUD completo con sistema de permisos granular
- **Casos de uso**: Super Admin, Admin, Vendedor, Cajero, etc.

### 3. Personas
- **Prop√≥sito**: Almacenar informaci√≥n personal de individuos
- **Funcionalidades**: CRUD completo con validaciones de datos personales
- **Casos de uso**: Empleados, clientes, proveedores

### 4. Usuarios
- **Prop√≥sito**: Gestionar cuentas de acceso al sistema
- **Funcionalidades**: CRUD completo con autenticaci√≥n y autorizaci√≥n
- **Casos de uso**: Cuentas de empleados con acceso al sistema

## Caracter√≠sticas Principales

### üîê Seguridad y Autenticaci√≥n
- Autenticaci√≥n JWT requerida para todos los endpoints
- Autorizaci√≥n basada en roles
- Validaci√≥n de permisos por compa√±√≠a
- Encriptaci√≥n de contrase√±as con bcrypt

### üìä Validaciones Robustas
- Validaci√≥n de datos en m√∫ltiples capas (DTO, servicio, base de datos)
- Verificaci√≥n de unicidad en campos cr√≠ticos
- Validaci√≥n de relaciones entre entidades
- Sanitizaci√≥n de datos de entrada

### üîç Funcionalidades Avanzadas
- B√∫squeda y filtrado avanzado
- Paginaci√≥n configurable
- Ordenamiento din√°mico
- Soft delete para preservar integridad
- Estad√≠sticas y m√©tricas

### üèóÔ∏è Arquitectura Modular
- Separaci√≥n clara de responsabilidades
- Consultas SQL puras para m√°ximo rendimiento
- Interfaces bien definidas
- F√°cil mantenimiento y escalabilidad

## Endpoints Disponibles

### Tipos de Identificaci√≥n

#### GET /api/identification-types
Listar tipos de identificaci√≥n con filtros y paginaci√≥n.

**Par√°metros de consulta:**
- `page` (number): N√∫mero de p√°gina (default: 1)
- `limit` (number): Elementos por p√°gina (default: 10, max: 100)
- `search` (string): B√∫squeda por nombre o c√≥digo
- `sortBy` (string): Campo para ordenar (default: 'name')
- `sortOrder` ('ASC'|'DESC'): Orden de clasificaci√≥n (default: 'ASC')
- `isActive` (boolean): Filtrar por estado activo
- `createdFrom` (string): Fecha de creaci√≥n desde (ISO 8601)
- `createdTo` (string): Fecha de creaci√≥n hasta (ISO 8601)
- `includeStats` (boolean): Incluir estad√≠sticas de uso

**Respuesta exitosa (200):**
```json
{
  "data": [
    {
      "id": "uuid",
      "name": "C√©dula de Ciudadan√≠a",
      "code": "CC",
      "description": "Documento de identificaci√≥n nacional",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "stats": {
        "totalPersons": 150
      }
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10,
  "totalPages": 1,
  "hasNext": false,
  "hasPrev": false
}
```

#### GET /api/identification-types/:id
Obtener un tipo de identificaci√≥n espec√≠fico.

**Par√°metros:**
- `id` (UUID): ID del tipo de identificaci√≥n

**Respuesta exitosa (200):**
```json
{
  "id": "uuid",
  "name": "C√©dula de Ciudadan√≠a",
  "code": "CC",
  "description": "Documento de identificaci√≥n nacional",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

#### POST /api/identification-types
Crear un nuevo tipo de identificaci√≥n.

**Permisos requeridos:** Super Admin

**Cuerpo de la solicitud:**
```json
{
  "name": "Pasaporte",
  "code": "PASS",
  "description": "Documento de identificaci√≥n internacional"
}
```

**Respuesta exitosa (201):**
```json
{
  "id": "uuid",
  "name": "Pasaporte",
  "code": "PASS",
  "description": "Documento de identificaci√≥n internacional",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

#### PATCH /api/identification-types/:id
Actualizar un tipo de identificaci√≥n existente.

**Permisos requeridos:** Super Admin o Admin

**Par√°metros:**
- `id` (UUID): ID del tipo de identificaci√≥n

**Cuerpo de la solicitud:**
```json
{
  "name": "Pasaporte Internacional",
  "description": "Documento de identificaci√≥n internacional actualizado"
}
```

#### DELETE /api/identification-types/:id
Eliminar (soft delete) un tipo de identificaci√≥n.

**Permisos requeridos:** Super Admin

**Par√°metros:**
- `id` (UUID): ID del tipo de identificaci√≥n

### Roles

#### GET /api/roles
Listar roles con filtros y paginaci√≥n.

**Par√°metros de consulta:** (similares a tipos de identificaci√≥n)

**Respuesta exitosa (200):**
```json
{
  "data": [
    {
      "id": "uuid",
      "name": "Vendedor",
      "description": "Rol para personal de ventas",
      "permissions": {
        "sales": { "read": true, "write": true },
        "inventory": { "read": true, "write": false }
      },
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "stats": {
        "totalUsers": 25
      }
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10,
  "totalPages": 1,
  "hasNext": false,
  "hasPrev": false
}
```

#### POST /api/roles
Crear un nuevo rol.

**Permisos requeridos:** Super Admin

**Cuerpo de la solicitud:**
```json
{
  "name": "Cajero",
  "description": "Rol para personal de caja",
  "permissions": {
    "sales": { "read": true, "write": true },
    "payments": { "read": true, "write": true },
    "inventory": { "read": true, "write": false }
  }
}
```

### Personas

#### GET /api/persons
Listar personas con filtros y paginaci√≥n.

**Par√°metros de consulta adicionales:**
- `identificationTypeId` (UUID): Filtrar por tipo de identificaci√≥n
- `includeIdentificationType` (boolean): Incluir datos del tipo de identificaci√≥n

**Respuesta exitosa (200):**
```json
{
  "data": [
    {
      "id": "uuid",
      "identificationTypeId": "uuid",
      "identificationNumber": "12345678",
      "firstName": "Juan",
      "lastName": "P√©rez",
      "email": "juan.perez@example.com",
      "phone": "+57 300 123 4567",
      "address": "Calle 123 #45-67",
      "birthDate": "1990-05-15",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "identificationType": {
        "id": "uuid",
        "name": "C√©dula de Ciudadan√≠a",
        "code": "CC"
      }
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10,
  "totalPages": 1,
  "hasNext": false,
  "hasPrev": false
}
```

#### POST /api/persons
Crear una nueva persona.

**Cuerpo de la solicitud:**
```json
{
  "identificationTypeId": "uuid",
  "identificationNumber": "87654321",
  "firstName": "Mar√≠a",
  "lastName": "Gonz√°lez",
  "email": "maria.gonzalez@example.com",
  "phone": "+57 300 987 6543",
  "address": "Carrera 45 #67-89",
  "birthDate": "1985-08-20"
}
```

### Usuarios

#### GET /api/users
Listar usuarios con filtros y paginaci√≥n.

**Par√°metros de consulta adicionales:**
- `companyId` (UUID): Filtrar por compa√±√≠a
- `roleId` (UUID): Filtrar por rol
- `includeDetails` (boolean): Incluir datos de persona, compa√±√≠a y rol

**Respuesta exitosa (200):**
```json
{
  "data": [
    {
      "id": "uuid",
      "personId": "uuid",
      "companyId": "uuid",
      "roleId": "uuid",
      "username": "juan.perez",
      "email": "juan.perez@company.com",
      "isActive": true,
      "lastLogin": "2024-01-01T10:30:00.000Z",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "person": {
        "id": "uuid",
        "firstName": "Juan",
        "lastName": "P√©rez",
        "email": "juan.perez@example.com"
      },
      "company": {
        "id": "uuid",
        "name": "StampOut POS Demo",
        "code": "DEMO"
      },
      "role": {
        "id": "uuid",
        "name": "Vendedor",
        "permissions": {}
      }
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10,
  "totalPages": 1,
  "hasNext": false,
  "hasPrev": false
}
```

#### POST /api/users
Crear un nuevo usuario.

**Cuerpo de la solicitud:**
```json
{
  "personId": "uuid",
  "companyId": "uuid",
  "roleId": "uuid",
  "username": "maria.gonzalez",
  "password": "password123",
  "email": "maria.gonzalez@company.com"
}
```

## Validaciones y Restricciones

### Tipos de Identificaci√≥n
- **name**: Requerido, √∫nico, m√°ximo 100 caracteres
- **code**: Requerido, √∫nico, m√°ximo 10 caracteres
- **description**: Opcional, m√°ximo 500 caracteres

### Roles
- **name**: Requerido, √∫nico, m√°ximo 100 caracteres
- **description**: Opcional, m√°ximo 500 caracteres
- **permissions**: Objeto JSON con estructura de permisos

### Personas
- **identificationTypeId**: Requerido, debe existir
- **identificationNumber**: Requerido, √∫nico por tipo de identificaci√≥n
- **firstName**: Requerido, m√°ximo 100 caracteres
- **lastName**: Requerido, m√°ximo 100 caracteres
- **email**: Opcional, formato de email v√°lido, √∫nico
- **phone**: Opcional, m√°ximo 20 caracteres
- **birthDate**: Opcional, fecha v√°lida

### Usuarios
- **personId**: Requerido, debe existir, una persona por usuario
- **companyId**: Opcional, se usa la del usuario actual si no se especifica
- **roleId**: Requerido, debe existir
- **username**: Requerido, √∫nico, 3-50 caracteres
- **password**: Requerido, m√≠nimo 6 caracteres
- **email**: Opcional, formato de email v√°lido

## C√≥digos de Error

### Errores Comunes
- **400 Bad Request**: Datos de entrada inv√°lidos
- **401 Unauthorized**: Token de autenticaci√≥n requerido
- **403 Forbidden**: Permisos insuficientes
- **404 Not Found**: Recurso no encontrado
- **409 Conflict**: Conflicto de unicidad (duplicados)
- **500 Internal Server Error**: Error interno del servidor

### Ejemplos de Respuestas de Error

**400 Bad Request:**
```json
{
  "message": [
    "name should not be empty",
    "code must be shorter than or equal to 10 characters"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```

**409 Conflict:**
```json
{
  "message": "Ya existe un tipo de identificaci√≥n con este nombre",
  "error": "Conflict",
  "statusCode": 409
}
```

## Relaciones entre Entidades

### Diagrama de Relaciones
```
identification_types (1) -----> (N) persons
                                   |
                                   | (1)
                                   v
companies (1) -----> (N) users <----- (N) roles
                                   |
                                   | (1)
                                   v
                               persons
```

### Descripci√≥n de Relaciones
1. **Tipos de Identificaci√≥n ‚Üí Personas**: Un tipo puede tener muchas personas
2. **Personas ‚Üí Usuarios**: Una persona puede tener un usuario (1:1)
3. **Compa√±√≠as ‚Üí Usuarios**: Una compa√±√≠a puede tener muchos usuarios
4. **Roles ‚Üí Usuarios**: Un rol puede ser asignado a muchos usuarios

## Consideraciones de Rendimiento

### Optimizaciones Implementadas
- √çndices en campos de b√∫squeda frecuente
- Consultas SQL optimizadas
- Paginaci√≥n para evitar cargas masivas
- Soft delete para preservar integridad referencial

### Recomendaciones
- Usar filtros espec√≠ficos en consultas grandes
- Limitar el n√∫mero de elementos por p√°gina
- Implementar cach√© para datos est√°ticos (tipos, roles)
- Monitorear consultas lentas

## Seguridad

### Medidas Implementadas
- Autenticaci√≥n JWT obligatoria
- Autorizaci√≥n basada en roles
- Validaci√≥n de permisos por compa√±√≠a
- Encriptaci√≥n de contrase√±as
- Sanitizaci√≥n de datos de entrada
- Protecci√≥n contra inyecci√≥n SQL

### Buenas Pr√°cticas
- Cambiar contrase√±as regularmente
- Usar roles con permisos m√≠nimos necesarios
- Auditar accesos y cambios
- Mantener logs de seguridad

## Casos de Uso Comunes

### 1. Registro de Nuevo Empleado
1. Crear persona con datos personales
2. Crear usuario asociado a la persona
3. Asignar rol apropiado
4. Configurar permisos espec√≠ficos

### 2. Gesti√≥n de Roles
1. Definir nuevo rol con permisos espec√≠ficos
2. Asignar rol a usuarios existentes
3. Modificar permisos seg√∫n necesidades
4. Desactivar roles obsoletos

### 3. Actualizaci√≥n de Informaci√≥n Personal
1. Modificar datos de persona
2. Actualizar informaci√≥n de contacto
3. Cambiar datos de usuario si es necesario
4. Mantener historial de cambios

## Mantenimiento y Monitoreo

### Tareas de Mantenimiento
- Limpieza peri√≥dica de registros inactivos
- Actualizaci√≥n de √≠ndices de base de datos
- Revisi√≥n de permisos y roles
- Backup de datos cr√≠ticos

### M√©tricas a Monitorear
- N√∫mero de usuarios activos
- Frecuencia de login por usuario
- Distribuci√≥n de roles
- Tiempo de respuesta de endpoints

## Conclusi√≥n

El m√≥dulo de Gesti√≥n de Personas proporciona una base s√≥lida y escalable para la gesti√≥n de recursos humanos en el sistema StampOut POS. Con su arquitectura modular, validaciones robustas y sistema de seguridad avanzado, permite un control granular de usuarios y permisos mientras mantiene la flexibilidad necesaria para adaptarse a diferentes necesidades organizacionales.

Todo Probado y ok 